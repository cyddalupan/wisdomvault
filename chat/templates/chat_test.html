<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Facebook Messenger Test</title>
    <style>
        .chat-bubble {
            max-width: 80%;
            margin: 6px 0;
            padding: 10px 14px;
            border-radius: 16px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            line-height: 1.3;
            display: inline-block;
            word-wrap: break-word;
        }
        .user-bubble {
            background-color: #DCF8C6;
            align-self: flex-end;
            margin-left: auto;
        }
        .bot-bubble {
            background-color: #ECECEC;
            align-self: flex-start;
            margin-right: auto;
        }
        .chat-container {
            display: flex;
            flex-direction: column;
            border: 1px solid #ccc;
            height: 220px;
            overflow-y: auto;
            padding: 8px;
            background: #fafafa;
            margin-top: 10px;
            border-radius: 8px;
        }
        .section {
            height: 350px;
        }
        label, input, button {
            font-family: Arial, sans-serif;
        }
    </style>
</head>
<body>
<h1>Test Facebook Messenger Chat</h1>

<!-- Left side for User -->
<div style="float:left; width: 45%; margin-right: 10%;" class="section">
    <h2>User (ID: 987654321)</h2>
    <label for="message_987654321">Message:</label><br />
    <input type="text" id="message_987654321" placeholder="Type a message here..." />
    <button onclick="sendMessage('987654321')">Send (User)</button>
    <div id="chat_bubbles_987654321" class="chat-container"></div>
</div>

<!-- Right side for Admin -->
<div style="float:left; width: 45%;" class="section">
    <h2>Admin (ID: 332211)</h2>
    <label for="message_332211">Message:</label><br />
    <input type="text" id="message_332211" placeholder="Type a message here..." />
    <button onclick="sendMessage('332211')">Send (Admin)</button>
    <div id="chat_bubbles_332211" class="chat-container"></div>
</div>

<div style="clear: both;"></div>

<script>
    //const token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0b2tlbl90eXBlIjoicmVmcmVzaCIsImV4cCI6MTc0NTU3NDE1NywiaWF0IjoxNzQ1NDg3NzU3LCJqdGkiOiJhNjQ5M2MxNDM3MDE0ZjYzYWEyNTYzNDQ4YmY4MDgyMyIsInVzZXJfaWQiOjF9.kkdivziAlfl2FiSmxICJQ2MmTxC19Ny_Pxgv2VZfcAc";

    function buildChatBubbles(history, sendID) {
        const container = document.getElementById('chat_bubbles_' + sendID);
        container.innerHTML = '';
        for (const chat of history) {
            // User's message bubble (assume user's message came from sendID)
            const userBubble = document.createElement('div');
            userBubble.className = 'chat-bubble user-bubble';
            userBubble.textContent = chat.message;
            container.appendChild(userBubble);

            // Bot's reply bubble
            const botBubble = document.createElement('div');
            botBubble.className = 'chat-bubble bot-bubble';
            botBubble.textContent = chat.reply || '(No reply)';
            container.appendChild(botBubble);
        }
        container.scrollTop = container.scrollHeight;
    }

    function fetchChatHistory(sendID) {
        fetch(`/chat/history/?user_id=${encodeURIComponent(sendID)}`, {
            method: 'GET',
            headers: {
                //'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) throw new Error("HTTP " + response.status);
            return response.json();
        })
        .then(data => {
            if (data.history) {
                buildChatBubbles(data.history, sendID);
            } else {
                console.error('No history data returned');
            }
        })
        .catch(err => {
            console.error('Error fetching chat history:', err);
        });
    }

    function sendMessage(sendID) {
        const messageInput = document.getElementById('message_' + sendID);
        const message = messageInput.value.trim();
        if (!message) {
            alert('Please enter a message');
            return;
        }

        fetch('/chat/webhook/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                object: 'page',
                entry: [{
                    id: '123456789',
                    messaging: [{
                        sender: { id: sendID },
                        message: { text: message }
                    }]
                }]
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'message processed') {
                // Message processed, clear input
                messageInput.value = '';
                // wait 3 seconds then fetch history
                setTimeout(() => fetchChatHistory(sendID), 6000);
            } else {
                alert('Error processing message');
            }
        })
        .catch(error => {
            alert('Error: ' + error);
        });
    }
</script>
</body>
</html>